## Смена номера телефона через API

### Описание

**Цель**: Тестирование функции смены номера телефона через API.

Тестирование включает проверку правил валидации, ограничений по частоте и количеству запросов, а также корректность записей в базе данных.

### Предусловия и необходимые инструменты

- Доступ к базе данных (таблица `idm_users`, `profile_customers`).
- Инструмент для тестирования API, например, Postman.
- Авторизованный пользователь, получивший токен с помощью TestCase 1 и TestCase 2.

### Тестовые данные

- Токен авторизованного пользователя: "valid_token".
- Новый номер телефона (настоящий): зарегистрированный в России или Казахстане, на который можно получить SMS-сообщение.
- Новый номер телефона (тестовый): диапазон номеров от +70000001261 до +70000001275.
- Код SMS для тестовых номеров: "666666".
- Код SMS для настоящих номеров: "код, отправленный на указанный номер".

### Шаги

#### Шаг 1: Запрос кода смены номера телефона (корректный номер)
Отправить POST-запрос на адрес `/api/idm/request-phone-change-phone-code` с body:
```json
{
  "phone": "Новый номер телефона (настоящий)"
}
```
и заголовком `Authorization: Bearer valid_token`.
Ожидаемый результат: Код успешно запрошен, код ответа 204. Запись добавлена в таблицу `idm_phone_verification_codes`.

#### Шаг 2: Запрос кода смены номера телефона (с превышением лимитов)
Отправить POST-запрос на адрес `/api/idm/request-phone-change-phone-code` с body:
```json
{
  "phone": "Новый номер телефона (настоящий)"
}
```
и заголовком `Authorization: Bearer valid_token` после пяти запросов с одного номера или 25 запросов с разных номеров за день.
Ожидаемый результат: Ошибка, код ответа 423 (Phone Verification Code Rate Limit Error), код не отправлен.

#### Шаг 3: Запрос кода смены номера телефона (чаще чем раз в 25 секунд)
Отправить повторный POST-запрос на адрес `/api/idm/request-phone-change-phone-code` с тем же номером телефона раньше, чем через 25 секунд.
Ожидаемый результат: Ошибка, код ответа 423 (Phone Verification Code Rate Limit Error), код не отправлен.

#### Шаг 4: Смена номера телефона (корректные данные)
Отправить POST-запрос на адрес `/api/profile/customer/change-phone` с body:
```json
{
  "phone": "Новый номер телефона (настоящий)",
  "code": "Код SMS для настоящих номеров"
}
```
и заголовком `Authorization: Bearer valid_token`.
Ожидаемый результат: Номер телефона успешно сменен, код ответа 200. В ответе присутствует модель пользователя с новым номером телефона. В таблице `idm_users` поле `phone` обновлено, сессия обновлена,
в таблице `profile_customers` поле `phone` обновлено.

#### Шаг 5: Смена номера телефона (некорректные данные)
Отправить POST-запрос на адрес `/api/profile/customer/change-phone` с body:
```json
{
  "phone": "12345",
  "code": "666666"
}
```
и заголовком `Authorization: Bearer valid_token`.
Ожидаемый результат: Ошибка, код ответа 400 (Invalid Phone Number), номер телефона не сменен.

#### Шаг 6: Смена номера телефона (некорректный код)
Отправить POST-запрос на адрес `/api/profile/customer/change-phone` с body:
```json
{
  "phone": "Новый номер телефона (настоящий)",
  "code": "654321"
}
```
и заголовком `Authorization: Bearer valid_token`.
Ожидаемый результат: Ошибка, код ответа 401 (authentication error), номер телефона не сменен.

#### Шаг 7: Запрос кода смены номера телефона без авторизации
Отправить POST-запрос на адрес `/api/idm/request-phone-change-phone-code` с body:
```json
{
  "phone": "+70000001234"
}
```
без заголовка `Authorization`.
Ожидаемый результат: Ошибка, код ответа 401 (Unauthorized), код не отправлен.

#### Шаг 8: Смена номера телефона без авторизации
Отправить POST-запрос на адрес `/api/profile/customer/change-phone` с body:
```json
{
  "phone": "+70000001234",
  "code": "666666"
}
```
без заголовка `Authorization`.
Ожидаемый результат: Ошибка, код ответа 401 (Unauthorized), номер телефона не сменен.

### Постусловия

- Проверить, что данные пользователя в таблицах `idm_users`, `profile_customers` соответствуют обновленным данным после успешного теста.
- Удалить тестовые данные из таблиц `idm_users`, `profile_customers` если это необходимо.

### Замечания/Примечания

- Необходимо убедиться, что коды ответов сервера и сообщения об ошибках соответствуют ожидаемым результатам.
- Проверить логирование событий для анализа возможных ошибок.
