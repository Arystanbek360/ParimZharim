## Получение access token по SMS-коду через API

### Описание

**Цель**: Тестирование функции получения access token по SMS-коду через API.

Тестирование включает проверку правильности данных, соответствия кода номеру телефона и корректность записей в базе данных.

### Предусловия и необходимые инструменты

- Доступ к базе данных (таблицы `idm_users` и `idm_personal_access_tokens`).
- Инструмент для тестирования API, например, Postman. 
- Запросить тестовый код на номер телефона (согласно тест-кейсу **test-case-1** "Запрос кода авторизации через API").


### Тестовые данные

- Номер телефона (настоящий): зарегистрированный в России или Казахстане, на который можно получить SMS-сообщение.
- Номер телефона (тестовый): диапазон номеров от +70000001231 до +70000001255.
- Device ID: "device123".
- Код SMS для тестовых номеров: "666666".

### Шаги

#### Шаг 1: Получение access token с корректными данными (настоящий номер телефона)
Отправить API-запрос на адрес `/api/profile/get-access-token-buy-auth-phone-code` с body:
```json
{
    "phone": "номер телефона зарегистрированный в России или Казахстане",
    "device_id": "device123",
    "code": "код из SMS-сообщения"
}
```
Ожидаемый результат: Access token получен, код ответа 200. В ответе присутствуют токен (строка) и модель пользователя со всеми полями. В таблице `idm_users` поле `phone_verified_at` обновлено, в таблице `idm_personal_access_tokens` добавлена запись для этого пользователя.

#### Шаг 2: Получение access token с корректными данными (тестовый номер телефона)
Отправить API-запрос на адрес `/api/profile/get-access-token-buy-auth-phone-code` с body:
```json
{
  "phone": "+70000001234",
  "device_id": "device123",
  "code": "666666"
}
```
Ожидаемый результат: Access token получен, код ответа 200. В ответе присутствуют токен (строка) и модель пользователя со всеми полями. В таблице `idm_users` поле `phone_verified_at` обновлено, в таблице `idm_personal_access_tokens` добавлена запись для этого пользователя.

#### Шаг 3: Получение access token с неверным номером телефона
Отправить API-запрос с неверным номером телефона, который никогда не использовался:
```json
{
  "phone": "+70000009999",
  "device_id": "device123",
  "code": "666666"
}
```
Ожидаемый результат: Ошибка, код ответа 404 (user not found), access token не получен.

#### Шаг 4: Получение access token без device_id
Отправить API-запрос без поля `device_id`:
```json
{
  "phone": "+70000001234",
  "code": "666666"
}
```
Ожидаемый результат: Ошибка, код ответа 422 (неправильно введенные данные), access token не получен.

#### Шаг 5: Получение access token с некорректным кодом SMS (тестовый номер телефона)
Отправить API-запрос с неверным кодом:
```json
{
  "phone": "+70000001234",
  "device_id": "device123",
  "code": "654321"
}
```
Ожидаемый результат: Ошибка, код ответа 401 (authentication error), access token не получен.

#### Шаг 6: Получение access token с некорректным кодом SMS (настоящий номер телефона)
Отправить API-запрос с неверным кодом:
```json
{
  "phone": "номер телефона зарегистрированный в России или Казахстане",
  "device_id": "device123",
  "code": "654321"
}
```
Ожидаемый результат: Ошибка, код ответа 401 (authentication error), access token не получен.

#### Шаг 7: Валидация телефона согласно маске (текущий тест-кейс)
Отправить API-запрос на адрес `/api/profile/get-access-token-buy-auth-phone-code` с body:
```json
{
  "phone": "12345",
  "device_id": "device123",
  "code": "123456"
}
``` 
Ожидаемый результат: Ошибка, код ответа 400 (Invalid Phone Number), access token не получен.

#### Шаг 8: Проверка повторного использования кода
После успешного получения access token (шаг 2), отправить повторный API-запрос с теми же данными:

```json
{
"phone": "+70000001234",
"device_id": "device123",
"code": "666666"
}
```
Ожидаемый результат: Ошибка, код ответа 401 (authentication error), access token не получен.

#### Шаг 9: Проверка истечения срока действия кода
Дождаться 30 минут после получения кода и отправить API-запрос с теми же данными:

```json
{
"phone": "+70000001234",
"device_id": "device123",
"code": "666666"
}
```
Ожидаемый результат: Ошибка, код ответа 401 (authentication error), access token не получен.

### Постусловия

- Удалить все тестовые данные из таблиц `idm_users` и `idm_personal_access_tokens`.
- Восстановить исходные настройки системы, если были изменены.

### Замечания/Примечания

- Необходимо убедиться, что коды ответов сервера и сообщения об ошибках соответствуют ожидаемым результатам.
- Проверить логирование событий для анализа возможных ошибок.
