## Проверка функциональности наличных платежей через API

### Описание

**Цель**: Проверка корректности работы функционала модуля Payment по API

Тестирование процесса создания заказа, выбора метода оплаты из списка доступных, создания платежа и проверки состояния платежа через ссылку.

### Предусловия и необходимые инструменты

- Авторизованный клиент с доступом к API.
- Токен авторизации.

### Тестовые данные
- Дата заказа: Произвольная свободная дата
- Клиент: Произвольный клиент.

### Шаги

#### Шаг 1:
Авторизоваться под произвольным пользователем.
**Ожидаемый результат**: Пользователь успешно авторизован.

#### Шаг 2:
Создать новый заказ через API с датой 18 августа.`{{host}}/api/orders/create`
**Ожидаемый результат**: Заказ успешно создан, получен ID заказа:
```
{
    "order_id": номер_заказа
}
```

#### Шаг 3:
Проверить доступные методы оплаты через запрос `GET /payment-methods`.
**Ожидаемый результат**: Возвращается список доступных методов оплаты:
```
[
    {
        "name": "название_платежной_системы_1",
        "is_available": true
    },
    {
        "name": "название_платежной_системы_2",
        "is_available": true
    }
]
```

#### Шаг 4:
Создать платеж для созданного заказа с использованием метода оплаты из полученного списка `{{host}}/api/orders/create-payment`
**Ожидаемый результат**: Платеж успешно создан, возвращена ссылка для оплаты:
```
{
    "payment_id": ID_платежа,
    "payment_url": "Ссылка на виджет для оплаты "
}
```


#### Шаг 5:
Перейти по полученной ссылке для оплаты.
**Ожидаемый результат**: Открывается виджет оплаты платежной системы.

#### Шаг 6:
Произвести оплату через виджет оплаты, используя данные карт с этой страницы: https://developers.cloudpayments.kz/#testirovanie
**Ожидаемый результат**: Статус платежа меняется согласно тестовой карте.

> Для каждой итерации необходимо создавать платеж из **Шага 4**

#### Шаг 7:
Проверить состояние платежа через API `{{host}}/api/payments/get-payments-for-order?order_id=167`
**Ожидаемый результат**: Возвращается корректный статус платежа:  
Для удачного платежа
```
[
    {
        "id": ID_платежа,
        "status": "Pending",
        "amount": сумма_платежа,
        "url": null
    }
]
```
Для неудачного платежа
```
[
    {
        "id": ID_платежа,
        "status": "Failed",
        "amount": сумма_платежа,
        "url": null
    }
]
```
#### Шаг 8:
Подтвердить\отменить платеж в кабинете CloudPayments
**Ожидаемый результат**: Возвращается корректный статус платежа:
В случае подтверждения:
```
[
    {
        "id": ID_платежа,
        "status": "Success",
        "amount": сумма_платежа,
        "url": null
    }
]
```
В случае отмены:
```
[
    {
        "id": ID_платежа,
        "status": "Canceled",
        "amount": сумма_платежа,
        "url": null
    }
]
```



### Негативные тесты

#### Шаг 9:
Создать заказ и попытаться использовать метод оплаты, не включенный в список доступных.
**Ожидаемый результат**: Возвращается ошибка 500 о недопустимом методе оплаты.

#### Шаг 10:
Создать платеж с некорректным ID заказа.
**Ожидаемый результат**: Возвращается ошибка о некорректном ID заказа.

#### Шаг 11:
Создать оплату для заказа, в котором уже создан платеж.
**Ожидаемый результат**: Ошибка 409 с сообщение о том, что фактическая предоплата уже создана:
```
{
    "message": "Application Error: Фактическая предоплата уже создана. Пожалуйста, обратитесь к администратору для уточнения деталей.",
    "status_code": 409
}
```



### Постусловия

- Удалить тестовый заказ и все связанные с ним данные для возврата системы в исходное состояние.

### Замечания/Примечания

- В случае ошибок или сбоев, уточнить настройки системы и повторить тестирование.
